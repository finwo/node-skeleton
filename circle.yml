general:
  branches:
    only:
      - v2
machine:
  environment:
    GCLOUD_PROJECT: trackthis-169509
    CLUSTER_NAME: cluster-1
    COMPUTE_ZONE: europe-west1-b

dependencies:
  pre:
  cache_directories:
    - "node_modules"
    - "bower_components"
  override:
    - npm install

deployment:
  production:
    branch: v2
    commands:
      # Authenticate & Settings
      - echo $GCLOUD_SERVICE_KEY | base64 -di > ${HOME}/client-secret.json
      - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/client-secret.json
      - sudo /opt/google-cloud-sdk/bin/gcloud config set project $GCLOUD_PROJECT
      - sudo /opt/google-cloud-sdk/bin/gcloud -q config set container/cluster $CLUSTER_NAME
      - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${COMPUTE_ZONE}
      - sudo /opt/google-cloud-sdk/bin/gcloud -q components install kubectl
      - sudo /opt/google-cloud-sdk/bin/gcloud -q container clusters get-credentials $CLUSTER_NAME

      # Deploy
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push us.gcr.io/${GCLOUD_PROJECT}/hello
